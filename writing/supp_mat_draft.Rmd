---
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: true
    citation_package: natbib
fontsize: 12pt
geometry: margin=1in
bibliography: White_bib.bib
header-includes: 
    \usepackage{float}
    \renewcommand{\thepage}{S\arabic{page}} 
    \renewcommand{\thesection}{S\arabic{section}}  
    \renewcommand{\thetable}{S\arabic{table}}  
    \renewcommand{\thefigure}{S\arabic{figure}}
---

\vspace{2cm}

\begin{center}
 \textbf{Supplementary Material: Article title here}
 
Authors: Easton R. White$^{1*}$
\vspace{3 mm}

Address: \\ \emph{$^1$ Center for Population Biology, University of California-Davis, Davis, California 95616 USA}

*Corresponding author: eawhite@ucdavis.edu

June 22, 2017
 \end{center}

\vspace{2cm}

This supplementary material includes:

1. Detailed example of subsampling and power calculations
2. Additional figures
3. Figures and results from other questions of interest
4. Additional references


Code for all the figures and tables can be found at [](https://github.com/erwhite1).

\vspace{2cm}


## Detailed example of subsampling and power calculations

Here, we illustrate in detail how we performed the subsampling and power calculations for a specific population. As an example, we examine a 35-year time series of (). Simple linear regression indicates a significant decline for this population with a blank and blank. We assume that this significant decline over 35 years is in fact the ``true trend". In statistical jargon, the 35-year trend is an effect that is actually present. We can then use this as a benchmark to see if subsamples of the time series show a similar result.

We first extract all contiguous subsamples of the time series. This leads to 34 two-year subsamples, 33 two-year subsamples, and so forth until a single 35-year subsample. We can call each set of subsamples, of the same length, a set. For each subsample, we conduct linear regression and extract model coefficients and p-values. Then, the fraction of subsamples within a set that show significant trends (signfiiant slope coefficient) is the statistical power. It is important to note that we only consider subsamples to be significant if they are significant in the same direction as the complete 35-year time series.

We can then plot statistical power as a function of time series length. As expected, we can see that power increases with the more years that are sampled. 

Then, we determine an appropriate level of statistical power that we find acceptable. Traditionally, this has been at 0.8, however, this is purely historical. Statisical power of 0.8 implies...

With statistical power of 0.8, we then determine the minimum time series length ($t_min$) required to achieve that level of statistical power. Here, $t_min$ is the first point as which all points to the right are above 0.8. 


```{r, echo=F}
# show an example of subsampling and power calculation routines
```



## Additional results from the main manuscript

```{r, echo=F}
setwd("~/Desktop/Research/time-series-project")
load('cleaned-data/combined_databases_with_min_time_linear_regression.Rdata')
```

In the main manuscript, we examined the minimum time required to detect a significant trend in abundance over time using linear regression. As detailed in the main manuscript the minimum time required was around 15, but there was a wide distribution. Therefore, we were interested in potential explanatory variables of the minimum time required. In the main manuscript, we examined characteristics of the time series itself, like variability, autocorrelation, and the trend in abundance over time. Here, we combined our time series database with a database on life history characteristics of amniotes from (cite other database here). There was life history information available for `r nrow(LPI_pop_info)` populations representing `r length(table(LPI_pop_info$Binomial))` different species, all of which were in the Aves class. 

We then correlated minimum time required for each population with its corresponding life history characteristics. In figure \ref{fig:biological_correlates} we examined miminmum time required versus generation length (years), litter size (n), adult body mass (grams), maximum longevity (years), egg mass (grams), and incubation (days). None of these variables had much explanatory power in accounting for the variance in the minimum time required. see table \ref{table:model_output}}


```{r, echo=F, fig.cap='Mimimum time required versus (a) generation length (years), (b) litter size (n), (c) adult body mass (grams), (d) maximum longevity (years), (e) egg mass (grams), and (f) incubation (days). The lines in each plot represent the best fit line from linear regression.\\label{fig:biological_correlates}',fig.height=6}

par(mfrow=c(3,2),oma=c(5,4,1,1),mar=c(5,3,0,0))

n=1
x_axis_name_list = c('generation length (years)','litter size (n)','adult body mass (grams)','maximum longevity (years)','egg mass (grams)','incubation (days)')
for (x_axis_name in names(LPI_pop_info)[20:25]){
  plot(LPI_pop_info[[x_axis_name]],LPI_pop_info$min_time_for_power,pch=16,col=rgb(0.5,0.5,0.5,0.5),las=1,ylab='',xlab='',cex.axis=1.2)
  abline(lm(LPI_pop_info$min_time_for_power~LPI_pop_info[[x_axis_name]]),lwd=3)

  mtext(text = x_axis_name_list[n],side = 1,line = 3,cex = 1.2)
  mtext(text = paste('(',letters[n],')',sep=''),side = 3,line=-1.5,adj = 0.98,cex=1.2)
  n=n+1
}

mtext(text = 'minimum time required',side = 2,line = 2,cex = 1.4,outer = TRUE)

```


\pagebreak

In the main text, we explained how the minimum time required strongly correlated with the trend strength, temporal autocorrelation, and variance in population size. Here we use a generalized linear model framework with a Poisson error structure to determine drivers of the minimum time required. In figure, \ref{fig:poisson_model} we show a set of residual plots for the regression. We then show the coefficient estimates and levels of significance in table \ref{table:model_output}.

```{r poisson_model, echo=F,include=T,fig.cap='Output of poisson regression...\\label{fig:poisson_model}'}
setwd("~/Desktop/Research/time-series-project")
load("cleaned-data/cleaned_timeseries_database_with_min_time_linear_regression.Rdata")

# GLM with Poisson error structure (include all terms - it is best not to include abs_overall_trend with variance as they are strongly corrrelated to one another)
pop_info$abs_overall_trend = abs(pop_info$overall_trend)
poisson_model <-glm(min_time_for_power~ abs_overall_trend + autocorrelation + variance + gen_len,family = 'poisson',data=pop_info)

  par(mfrow=c(2,2),mar=c(5,5,1,2),oma=c(0,0,0.5,0))
    plot(poisson_model,cex.lab=1.2,las=1,cex.axis=1.2,main=' ',pch=16, col=rgb(0.5,0.5,0.5,0.4))
#R^2 calculation (pg. 218 Zuur et al. 2009 mixed effects book)
R2_fullmodel <- 100*(poisson_model$null.deviance - poisson_model$deviance)/(poisson_model$null.deviance)



poisson_model_no_variance <-glm(min_time_for_power~ abs_overall_trend + autocorrelation + gen_len,family = 'poisson',data=pop_info)
R2_no_variance <- 100*(poisson_model_no_variance$null.deviance - poisson_model_no_variance$deviance)/(poisson_model_no_variance$null.deviance)

poisson_model_no_trend <-glm(min_time_for_power~ autocorrelation + variance + gen_len,family = 'poisson',data=pop_info)
R2_no_trend <- 100*(poisson_model_no_trend$null.deviance - poisson_model_no_trend$deviance)/(poisson_model_no_trend$null.deviance)

```

```{r,echo=F,message=F,warning=F}

require(knitr)
knitr::kable(summary(poisson_model)$coef,caption = 'Stuff here\\label{table:model_output}')

```


Our model with trend strength, autocorrelation, variance, and generation length accounted for `r round(R2_fullmodel,2)`% of the variation in the minimum time required. However, we also found trend strength and variance to be strongly correlated with one another. Therefore, we ran two additional models with either trend strength or variance, but not both together. This resulted in lower explained deviance (analogue to $R^2$) of `r round(R2_no_variance,2)`% and `r round(R2_no_trend,2)`%, respectively.




\pagebreak

## Results from other questions of interest






### Growth rate calculations

Instead of detecting a trend over time with linear regression, we could also calculate the geometric growth rate of the population. In figure \ref{fig:growth_rate}, we show how to calculate growth rates for subsamples of a time series. First, we created subsamples of each possible length from the full 35 year time series, as we did in the main next. Next, we calculated the mean and standard deviation of growth rates for each possible time series length (Fig. \ref{fig:growth_rate}b). Lastly, we calculated the percent error $\mbox{percent error} = 100 \times \left| \frac{\mbox{observed} - \mbox{theoretical}}{\mbox{theoretical}} \right|$ between the mean of each time series length (observed) and the overall population growth rate (theoretical). In Fig. \ref{fig:growth_rate}c), we show the percent error as a function of time series length. Here we define the minimum time required as the minimum number of years to achieve less than 20% error. 

```{r, echo=F, fig.cap='Example of calculating minimum time required for growth rate estimation. (a) abundance over time, (b) mean and standard deviation of growth rate for subsamples of entire time series, and (c) the percent error between mean estimated growth rate and the true longterm growth rate. The vertical bar denotes the minimum time required to estimate growth rate within 10% error.\\label{fig:growth_rate}'}
#Example of using population growth rate instead of power
setwd("/Users/eastonwhite/Desktop/Research/time-series-project")
source("scripts/calculate_geometric_growth.R")
load('cleaned-data/cleaned_timeseries_database.Rdata')

par(mfrow=c(1,3),oma=c(0,1,0,0))

  pop = subset(long_dat,long_dat$ID=='10007') #13192 for Harp seals
  source('scripts/create_subsamples.R')
  source('scripts/percent_error.R')
  aaa=calculate_average_geometric_growth(pop$popvalue)
  plot(pop$year,pop$popvalue,cex.axis=1.2,cex.lab=1.2,ylab='',xlab='',pch=16,las=1)
    #abline(lm(pop$popvalue~pop$year),lwd=2,col='red')
    mtext(text = 'year',1,line=3,cex=1.4)
    mtext(text = 'population size',2,line=3.5,cex=1.4)

  
  plot(rowMeans(aaa,na.rm=T),cex.axis=1.2,pch=16,ylab='',xlab='',las=1)
    mtext(text = 'years sampled',1,line=3,cex=1.4)
    mtext(text = 'population growth rate',2,line=3.7,cex=1.4)
    
    abline(h= -0.01*rowMeans(aaa,na.rm = T)[34] +rowMeans(aaa,na.rm = T)[34] )
    abline(h= 0.01*rowMeans(aaa,na.rm = T)[34] +rowMeans(aaa,na.rm = T)[34] )
    
    arrows(1:34,rowMeans(aaa,na.rm=T),1:34,rowMeans(aaa,na.rm=T)+sd(apply(aaa,MARGIN = 1,FUN=var,na.rm=T),na.rm=T),angle = 90,length = 0.1)
    arrows(1:34,rowMeans(aaa,na.rm=T),1:34,rowMeans(aaa,na.rm=T)-sd(apply(aaa,MARGIN = 1,FUN=var,na.rm=T),na.rm=T),angle = 90,length = 0.1)
    
    
    plot(percent_error(rowMeans(aaa,na.rm=T),rowMeans(aaa,na.rm=T)[34]),cex.axis=1.2,pch=16,ylab='',xlab='',las=1)
    mtext(text = 'years sampled',1,line=3,cex=1.4)
    mtext(text = 'percent error in growth rate',2,line=3.7,cex=1.4)
    abline(h=0.1,lty=2)
    abline(v=tail(which(percent_error(rowMeans(aaa,na.rm=T),rowMeans(aaa,na.rm=T)[34])>0.1),1)+1,lty=2)
```



We applied the same calculations to `r nrow(pop_info)` populations, as we did in the main text. We then obtain a distribution of the minimum time required to measure the ``true" longterm growth rate (Fig. \ref{fig:min_time_growth_dist}). We see a bimodal distribution with many populations required 30+ years to estimate the longterm growth rate. The large number of short year required is due to cases where the entire time series is consistently increasing or decreasing at the same rate. 

```{r, echo=F,eval=F,fig.cap='Histogram of the minimum time required in order to estimate the longterm growth rate within 20% error.\\label{fig:min_time_growth_dist}'}
# Growth rates calculations for each species
setwd("/Users/eastonwhite/Desktop/Research/time-series-project")
load('cleaned-data/cleaned_timeseries_database.Rdata')

 for (j in 1:nrow(pop_info)){
    pop= subset(long_dat,long_dat$ID==pop_info$ID[j])[1:35,]
    pop$popvalue=as.numeric(pop$popvalue)
    pop$popvalue=pop$popvalue/max(pop$popvalue) #should I standaridize this in a better way
    
   # source('scripts/calculate_power_metric.R')
    aaa=calculate_average_geometric_growth(pop$popvalue)
    if (length(which(percent_error(rowMeans(aaa,na.rm=T),rowMeans(aaa,na.rm=T)[34])>0.2))==0){
      pop_info$min_time_growth_rate[j] = 2
    }else{
      pop_info$min_time_growth_rate[j] = tail(which(percent_error(rowMeans(aaa,na.rm=T),rowMeans(aaa,na.rm=T)[34])>0.2),1)+1}
    #print(paste(j,':',pop_info$min_time_for_power[j],sep=' '))
 }


# Create plot
par(mfrow=c(1,1))
hist(pop_info$min_time_growth_rate,las=1,ylab='',xlab='',cex.axis=1.2,main='',breaks=20,xlim=c(0,40),ylim=c(0,500))
mtext(text = 'Frequency',2,line=3,cex=1.2)
mtext(text = 'Minimum time required',1,line=3,cex=1.2)

```


\clearpage 

### Using Generalized additive model to identify significant trends

In the main text, we examined the minimum time required to identify a trend in abundance via linear regression. This approach allowed us to identify increases or decreases, but a linear model may not always be a good fit. Generalized additive models (GAMs) are more general than general linear models and allow more flexible. GAMs are models where a response variable depends on unknown smooth functions of explanatory variables. GAMs, therefore, can identify relationships between response variables and explantory variables that are non-linear and perhaps more complicated. The downsite of GAMs...

Here, we conduct the same analyses in the main text, but instead calculate the minimum time series required to detect trends over time according to a GAM model. We hypothesize that GAMs should require less time to detect a trend as they are more flexible than linear regression. We provide an example that shows statistical power increases with more time sampled (Fig. \ref{fig:gam_example}).


```{r,echo=F,fig.cap='results here from GAM.\\label{fig:gam_example}'}
# show gam example side-by-side plot
plot(1,1)
```

We then fit GAM models for XX populations. We found... (Fig. \ref{fig:gam_result}). This is shorter/longer than the main text question.

```{r,echo=F,eval=F,fig.cap='results here from GAM.\\label{fig:gam_result}'}
# show gam results for minimium time required
setwd("/Users/eastonwhite/Desktop/Research/time-series-project")
load('cleaned-data/cleaned_timeseries_database.Rdata')

 for (j in 1:nrow(pop_info)){
    pop= subset(long_dat,long_dat$ID==pop_info$ID[j])[1:35,]
    pop$popvalue=as.numeric(pop$popvalue)
    pop$popvalue=pop$popvalue/max(pop$popvalue) #should I standaridize this in a better way
 
    source('scripts/calculate_power_metric_gam.R')
    pop_info$min_time_for_power_gam[j] = min_time_needed(pop$popvalue,0.05,0.8)
    print(paste(j,':',pop_info$min_time_for_power[j],sep=' '))
 }


# Create plot
par(mfrow=c(1,1))
hist(pop_info$min_time_growth_rate,las=1,ylab='',xlab='',cex.axis=1.2,main='',breaks=20,xlim=c(0,40),ylim=c(0,500))
mtext(text = 'Frequency',2,line=3,cex=1.2)
mtext(text = 'Minimum time required',1,line=3,cex=1.2)

```



### Minimum time to detect density-dependence in time series

For decades, the importance of density-dependence in natural populations has been an important question in ecology (citations). To address this question, @Knape2012 used data from the Global Population Dynamics Database [@GPDD2010]. They fitted 627 time series with a Gompertz population model and found evidence for density-dependence in 45% of the time series. Each time series in their database contained at least 15 datapoints, and ranged from 15 to 157. A follow up question to their work would be, what time series length is required to confidently estimate density-dependence. 

\clearpage
### References
